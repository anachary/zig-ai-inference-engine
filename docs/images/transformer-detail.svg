<?xml version="1.0" encoding="UTF-8"?>
<svg width="1200" height="700" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .title { font: bold 16px Arial; text-anchor: middle; fill: #333; }
      .node { font: 10px Arial; text-anchor: middle; fill: #333; }
      .subgraph-title { font: bold 12px Arial; text-anchor: middle; fill: #666; }
      .arrow { stroke: #333; stroke-width: 1.5; fill: none; marker-end: url(#arrowhead); }
      .process { stroke: #1976d2; stroke-width: 2; fill: #e3f2fd; }
      .attention { stroke: #f57c00; stroke-width: 2; fill: #fff3e0; }
      .ffn { stroke: #c2185b; stroke-width: 2; fill: #fce4ec; }
      .math { stroke: #7b1fa2; stroke-width: 2; fill: #f3e5f5; }
      .data { stroke: #388e3c; stroke-width: 2; fill: #e8f5e8; }
    </style>
    <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#333" />
    </marker>
  </defs>
  
  <!-- Title -->
  <text x="600" y="25" class="title">Transformer Layer Processing Detail</text>
  
  <!-- Input Flow -->
  <rect x="50" y="50" width="120" height="25" class="data" rx="3"/>
  <text x="110" y="67" class="node">Input Tokens</text>
  <text x="110" y="45" class="node" font-size="8">[3923, 374, 279, 7438, 315, 2324, 30]</text>
  
  <rect x="200" y="50" width="120" height="25" class="process" rx="3"/>
  <text x="260" y="67" class="node">Token Embedding</text>
  
  <rect x="350" y="50" width="120" height="25" class="data" rx="3"/>
  <text x="410" y="67" class="node">Hidden States</text>
  <text x="410" y="45" class="node" font-size="8">[7 × 896]</text>
  
  <!-- Layer Stack -->
  <rect x="500" y="40" width="80" height="25" class="process" rx="3"/>
  <text x="540" y="57" class="node">Layer 0</text>
  
  <rect x="600" y="40" width="80" height="25" class="process" rx="3"/>
  <text x="640" y="57" class="node">Layer 1</text>
  
  <rect x="700" y="40" width="80" height="25" class="process" rx="3"/>
  <text x="740" y="57" class="node">...</text>
  
  <rect x="800" y="40" width="80" height="25" class="process" rx="3"/>
  <text x="840" y="57" class="node">Layer 23</text>
  
  <rect x="920" y="40" width="100" height="25" class="process" rx="3"/>
  <text x="970" y="57" class="node">Output Proj</text>
  
  <rect x="1050" y="40" width="100" height="25" class="data" rx="3"/>
  <text x="1100" y="57" class="node">Next Token</text>
  <text x="1100" y="35" class="node" font-size="8">791 ("The")</text>
  
  <!-- Single Layer Detail -->
  <rect x="50" y="120" width="400" height="180" fill="none" stroke="#666" stroke-dasharray="3,3"/>
  <text x="250" y="140" class="subgraph-title">Single Transformer Layer</text>
  
  <rect x="70" y="150" width="80" height="20" class="data" rx="3"/>
  <text x="110" y="163" class="node">Input [7×896]</text>
  
  <rect x="70" y="180" width="80" height="20" class="process" rx="3"/>
  <text x="110" y="193" class="node">RMSNorm</text>
  
  <rect x="170" y="180" width="80" height="20" class="attention" rx="3"/>
  <text x="210" y="193" class="node">Multi-Head Attn</text>
  
  <rect x="270" y="180" width="80" height="20" class="process" rx="3"/>
  <text x="310" y="193" class="node">Residual Add</text>
  
  <rect x="70" y="210" width="80" height="20" class="process" rx="3"/>
  <text x="110" y="223" class="node">RMSNorm</text>
  
  <rect x="170" y="210" width="80" height="20" class="ffn" rx="3"/>
  <text x="210" y="223" class="node">SwiGLU FFN</text>
  
  <rect x="270" y="210" width="80" height="20" class="process" rx="3"/>
  <text x="310" y="223" class="node">Residual Add</text>
  
  <rect x="370" y="210" width="80" height="20" class="data" rx="3"/>
  <text x="410" y="223" class="node">Output [7×896]</text>
  
  <!-- Multi-Head Attention Detail -->
  <rect x="480" y="120" width="320" height="180" fill="none" stroke="#666" stroke-dasharray="3,3"/>
  <text x="640" y="140" class="subgraph-title">Multi-Head Attention Detail</text>
  
  <rect x="500" y="150" width="60" height="20" class="data" rx="3"/>
  <text x="530" y="163" class="node">Input [7×896]</text>
  
  <rect x="500" y="180" width="50" height="20" class="math" rx="3"/>
  <text x="525" y="193" class="node">Q Linear</text>
  
  <rect x="560" y="180" width="50" height="20" class="math" rx="3"/>
  <text x="585" y="193" class="node">K Linear</text>
  
  <rect x="620" y="180" width="50" height="20" class="math" rx="3"/>
  <text x="645" y="193" class="node">V Linear</text>
  
  <rect x="500" y="210" width="50" height="20" class="process" rx="3"/>
  <text x="525" y="223" class="node">Reshape</text>
  <text x="525" y="205" class="node" font-size="8">[7×14×64]</text>
  
  <rect x="560" y="210" width="50" height="20" class="process" rx="3"/>
  <text x="585" y="223" class="node">Reshape</text>
  
  <rect x="620" y="210" width="50" height="20" class="process" rx="3"/>
  <text x="645" y="223" class="node">Reshape</text>
  
  <rect x="680" y="180" width="80" height="20" class="math" rx="3"/>
  <text x="720" y="193" class="node">Scaled Dot-Product</text>
  <text x="720" y="175" class="node" font-size="8">QK^T/√64</text>
  
  <rect x="680" y="210" width="50" height="20" class="process" rx="3"/>
  <text x="705" y="223" class="node">Softmax</text>
  
  <rect x="740" y="210" width="50" height="20" class="process" rx="3"/>
  <text x="765" y="223" class="node">Concat</text>
  
  <rect x="680" y="240" width="80" height="20" class="math" rx="3"/>
  <text x="720" y="253" class="node">Output Linear</text>
  
  <!-- SwiGLU Detail -->
  <rect x="50" y="330" width="350" height="150" fill="none" stroke="#666" stroke-dasharray="3,3"/>
  <text x="225" y="350" class="subgraph-title">SwiGLU Feed-Forward Network</text>
  
  <rect x="70" y="370" width="80" height="20" class="data" rx="3"/>
  <text x="110" y="383" class="node">Input [7×896]</text>
  
  <rect x="70" y="400" width="80" height="20" class="math" rx="3"/>
  <text x="110" y="413" class="node">Gate Linear</text>
  <text x="110" y="395" class="node" font-size="8">[7×2432]</text>
  
  <rect x="170" y="400" width="80" height="20" class="math" rx="3"/>
  <text x="210" y="413" class="node">Up Linear</text>
  <text x="210" y="395" class="node" font-size="8">[7×2432]</text>
  
  <rect x="70" y="430" width="80" height="20" class="process" rx="3"/>
  <text x="110" y="443" class="node">SiLU Activation</text>
  
  <rect x="170" y="430" width="80" height="20" class="math" rx="3"/>
  <text x="210" y="443" class="node">Element Multiply</text>
  <text x="210" y="425" class="node" font-size="8">Gate ⊙ Up</text>
  
  <rect x="270" y="430" width="80" height="20" class="math" rx="3"/>
  <text x="310" y="443" class="node">Down Linear</text>
  <text x="310" y="425" class="node" font-size="8">[7×896]</text>
  
  <!-- Quantization Process -->
  <rect x="430" y="330" width="200" height="100" fill="none" stroke="#666" stroke-dasharray="3,3"/>
  <text x="530" y="350" class="subgraph-title">Quantization Process</text>
  
  <rect x="450" y="370" width="80" height="20" class="data" rx="3"/>
  <text x="490" y="383" class="node">Q4_K_M Weights</text>
  
  <rect x="450" y="400" width="80" height="20" class="process" rx="3"/>
  <text x="490" y="413" class="node">Dequantize</text>
  
  <rect x="540" y="400" width="80" height="20" class="data" rx="3"/>
  <text x="580" y="413" class="node">F32 Weights</text>
  
  <!-- KV Caching -->
  <rect x="650" y="330" width="200" height="100" fill="none" stroke="#666" stroke-dasharray="3,3"/>
  <text x="750" y="350" class="subgraph-title">KV Caching</text>
  
  <rect x="670" y="370" width="70" height="20" class="data" rx="3"/>
  <text x="705" y="383" class="node">Previous K,V</text>
  
  <rect x="750" y="370" width="70" height="20" class="process" rx="3"/>
  <text x="785" y="383" class="node">New Token</text>
  
  <rect x="710" y="400" width="70" height="20" class="process" rx="3"/>
  <text x="745" y="413" class="node">Update Cache</text>
  
  <!-- Performance Metrics -->
  <rect x="870" y="330" width="280" height="150" fill="none" stroke="#666" stroke-dasharray="3,3"/>
  <text x="1010" y="350" class="subgraph-title">Performance Breakdown</text>
  
  <text x="880" y="370" class="node">Single Token Generation (Qwen2-0.5B):</text>
  <text x="880" y="385" class="node">├── Token embedding: ~0.1ms</text>
  <text x="880" y="400" class="node">├── 24 transformer layers: ~45ms</text>
  <text x="880" y="415" class="node">│   ├── Attention: ~30ms (67%)</text>
  <text x="880" y="430" class="node">│   ├── Feed-forward: ~12ms (27%)</text>
  <text x="880" y="445" class="node">│   └── Layer norm: ~3ms (6%)</text>
  <text x="880" y="460" class="node">└── Output projection: ~2ms</text>
  
  <!-- Arrows for main flow -->
  <line x1="170" y1="62" x2="190" y2="62" class="arrow"/>
  <line x1="320" y1="62" x2="340" y2="62" class="arrow"/>
  <line x1="470" y1="62" x2="490" y2="62" class="arrow"/>
  <line x1="580" y1="52" x2="590" y2="52" class="arrow"/>
  <line x1="680" y1="52" x2="690" y2="52" class="arrow"/>
  <line x1="780" y1="52" x2="790" y2="52" class="arrow"/>
  <line x1="880" y1="52" x2="910" y2="52" class="arrow"/>
  <line x1="1020" y1="52" x2="1040" y2="52" class="arrow"/>
  
  <!-- Layer detail arrows -->
  <line x1="110" y1="170" x2="110" y2="180" class="arrow"/>
  <line x1="150" y1="190" x2="160" y2="190" class="arrow"/>
  <line x1="250" y1="190" x2="260" y2="190" class="arrow"/>
  <line x1="310" y1="200" x2="310" y2="210" class="arrow"/>
  <line x1="110" y1="200" x2="110" y2="210" class="arrow"/>
  <line x1="150" y1="220" x2="160" y2="220" class="arrow"/>
  <line x1="250" y1="220" x2="260" y2="220" class="arrow"/>
  <line x1="350" y1="220" x2="360" y2="220" class="arrow"/>
  
  <!-- Attention detail arrows -->
  <line x1="530" y1="170" x2="530" y2="180" class="arrow"/>
  <line x1="525" y1="200" x2="525" y2="210" class="arrow"/>
  <line x1="585" y1="200" x2="585" y2="210" class="arrow"/>
  <line x1="645" y1="200" x2="645" y2="210" class="arrow"/>
  <line x1="670" y1="190" x2="680" y2="190" class="arrow"/>
  <line x1="720" y1="200" x2="720" y2="210" class="arrow"/>
  <line x1="720" y1="230" x2="720" y2="240" class="arrow"/>
  
  <!-- SwiGLU arrows -->
  <line x1="110" y1="390" x2="110" y2="400" class="arrow"/>
  <line x1="110" y1="420" x2="110" y2="430" class="arrow"/>
  <line x1="150" y1="440" x2="160" y2="440" class="arrow"/>
  <line x1="250" y1="440" x2="260" y2="440" class="arrow"/>
  
  <!-- Quantization arrows -->
  <line x1="490" y1="390" x2="490" y2="400" class="arrow"/>
  <line x1="530" y1="410" x2="540" y2="410" class="arrow"/>
  
  <!-- KV Cache arrows -->
  <line x1="705" y1="390" x2="705" y2="400" class="arrow"/>
  <line x1="785" y1="390" x2="785" y2="400" class="arrow"/>
  <line x1="740" y1="400" x2="750" y2="400" class="arrow"/>
</svg>
